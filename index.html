<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Analytics Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚≠ê</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #1f2937;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #0f766e 0%, #115e59 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #0d9488;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.7;
            font-weight: 300;
        }
        
        .notice {
            background: #fef3c7;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #fbbf24;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notice-icon {
            font-size: 18px;
        }
        
        .notice-text {
            color: #92400e;
            font-size: 13px;
            font-weight: 500;
            line-height: 1.6;
        }
        
        .notice-text div {
            margin-bottom: 2px;
        }
        
        .notice-text div:last-child {
            margin-bottom: 0;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            min-width: 150px;
            background: #f9fafb;
            color: #1f2937;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #14b8a6;
            background: white;
        }
        
        .refresh-btn {
            padding: 11px 24px;
            background: #14b8a6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 18px;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: #0d9488;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .data-info {
            background: white;
            padding: 16px 24px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #14b8a6;
            color: #1f2937;
            font-size: 15px;
            text-align: center;
            font-weight: 500;
        }
        
        .data-info strong {
            color: #14b8a6;
            font-weight: 700;
            font-size: 16px;
        }
        
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }
        
        .kpi-card .label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .kpi-card .value {
            font-size: 36px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .kpi-card .change {
            font-size: 13px;
            color: #6b7280;
            font-weight: 400;
        }
        
        .kpi-card.positive .value {
            color: #14b8a6;
        }
        
        .kpi-card.neutral .value {
            color: #06b6d4;
        }
        
        .kpi-card.negative .value {
            color: #f43f5e;
        }
        
        .analysis-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }
        
        .analysis-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #1f2937;
            font-weight: 600;
        }
        
        .analysis-content {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            line-height: 1.6;
            color: #374151;
        }
        
        .analysis-content h3 {
            color: #14b8a6;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .analysis-content h3:first-child {
            margin-top: 0;
        }
        
        .analysis-content ul {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .analysis-content li {
            margin-bottom: 6px;
            color: #6b7280;
        }
        
        .analysis-loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 200px;
            align-items: flex-start;
            align-content: flex-start;
        }
        
        .keyword-tag {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            transition: transform 0.2s;
            cursor: default;
        }
        
        .keyword-tag:hover {
            transform: scale(1.05);
        }
        
        .keyword-positive {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #14b8a6;
        }
        
        .keyword-negative {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #f43f5e;
        }
        
        .keyword-neutral {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }
        
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: #d1d5db;
            font-size: 12px;
            font-weight: 300;
        }
        
        .analysis-btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(20, 184, 166, 0.3);
        }
        
        .analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(20, 184, 166, 0.4);
        }
        
        .analysis-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #14b8a6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-container {
            text-align: center;
            padding: 40px;
        }
        
        .loading-container .spinner {
            margin-bottom: 15px;
        }
        
        .loading-container .text {
            color: #6b7280;
            font-size: 14px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
        }
        
        .chart-card h3 {
            font-size: 16px;
            margin-bottom: 20px;
            color: #1f2937;
            font-weight: 600;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .table-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            overflow-x: auto;
        }
        
        .table-card h3 {
            font-size: 16px;
            margin-bottom: 20px;
            color: #1f2937;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: #f3f4f6;
        }
        
        th.sortable::after {
            content: ' ‚Üï';
            opacity: 0.3;
            font-size: 10px;
        }
        
        th.sorted-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
            color: #14b8a6;
        }
        
        th.sorted-desc::after {
            content: ' ‚ñº';
            opacity: 1;
            color: #14b8a6;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
            color: #374151;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .rating-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
        }
        
        .rating-5 { background: #0d9488; color: #ccfbf1; }
        .rating-4 { background: #0f766e; color: #99f6e4; }
        .rating-3 { background: #374151; color: #fde68a; }
        .rating-2 { background: #5a1e1e; color: #fca5a5; }
        .rating-1 { background: #7f1d1d; color: #fca5a5; }
        
        .device-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .device-ios {
            background: #0d9488;
            color: #ccfbf1;
        }
        
        .device-android {
            background: #0891b2;
            color: #cffafe;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6b7280;
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Review Analytics Dashboard</h1>
        <p>Ïã§ÏãúÍ∞Ñ Î¶¨Î∑∞ Î™®ÎãàÌÑ∞ÎßÅ Î∞è Ïù∏ÏÇ¨Ïù¥Ìä∏ Î∂ÑÏÑù</p>
    </div>
    
    <div class="notice">
        <span class="notice-icon">‚ö†Ô∏è</span>
        <div class="notice-text">
            <div>„ÉªÎç∞Ïù¥ÌÑ∞Îäî 2-3Ïùº ÏßÄÏó∞ÎêòÏñ¥ Ï†úÍ≥µÎê©ÎãàÎã§ (Apple Ï†ïÏ±ÖÏúºÎ°ú Ïù∏Ìïú ÏßÄÏó∞)</div>
            <div>„ÉªÌèâÏ†ê Îç∞Ïù¥ÌÑ∞Îäî Ïã§ÏãúÍ∞Ñ Ïä§ÌÜ†Ïñ¥ ÌèâÏ†êÍ≥º ÏÉÅÏù¥Ìï† Ïàò ÏûàÏäµÎãàÎã§</div>
        </div>
    </div>
    
    <div class="filters">
        <div class="filter-group">
            <label>Ïä§ÌÜ†Ïñ¥</label>
            <select id="storeFilter">
                <option value="all">Ï†ÑÏ≤¥</option>
                <option value="ios">iOS</option>
                <option value="android">Android</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>ÌèâÏ†ê</label>
            <select id="ratingFilter">
                <option value="all">Ï†ÑÏ≤¥</option>
                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
                <option value="3">‚≠ê‚≠ê‚≠ê</option>
                <option value="2">‚≠ê‚≠ê</option>
                <option value="1">‚≠ê</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label>Í∏∞Í∞Ñ (ÏãúÏûë)</label>
            <input type="date" id="startDate">
        </div>
        
        <div class="filter-group">
            <label>Í∏∞Í∞Ñ (Ï¢ÖÎ£å)</label>
            <input type="date" id="endDate">
        </div>
        
        <button class="refresh-btn" onclick="loadData()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
    </div>
    
    <div id="loading" class="loading">Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
    <div id="error" class="error" style="display: none;"></div>
    
    <div id="dashboard" style="display: none;">
        <div class="data-info" id="dataInfo">
            Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§Ä: <strong id="latestDataDate">-</strong> (Ïã§ÏãúÍ∞Ñ -3Ïùº)
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="label">Ï†ÑÏ≤¥ Î¶¨Î∑∞ Ïàò</div>
                <div class="value" id="totalReviews">0</div>
                <div class="change" id="reviewsChange"></div>
            </div>
            
            <div class="kpi-card">
                <div class="label">ÌèâÍ∑† ÌèâÏ†ê</div>
                <div class="value" id="avgRating">0.0</div>
                <div class="change" id="avgRatingDetails"></div>
            </div>
            
            <div class="kpi-card positive">
                <div class="label">Í∏çÏ†ï Î¶¨Î∑∞ (4-5Ï†ê)</div>
                <div class="value" id="positiveRate">0%</div>
                <div class="change" id="positiveCount">0Í∞ú</div>
            </div>
            
            <div class="kpi-card neutral">
                <div class="label">Ï§ëÎ¶Ω Î¶¨Î∑∞ (3Ï†ê)</div>
                <div class="value" id="neutralRate">0%</div>
                <div class="change" id="neutralCount">0Í∞ú</div>
            </div>
            
            <div class="kpi-card negative">
                <div class="label">Î∂ÄÏ†ï Î¶¨Î∑∞ (1-2Ï†ê)</div>
                <div class="value" id="negativeRate">0%</div>
                <div class="change" id="negativeCount">0Í∞ú</div>
            </div>
        </div>
        
        <div class="analysis-section">
            <h2>AI Î¶¨Î∑∞ Î∂ÑÏÑù</h2>
            <div style="background: #e0f2fe; padding: 12px 16px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #7dd3fc;">
                <span style="color: #075985; font-size: 13px;">
                    ‚ÑπÔ∏è ÌòÑÏû¨ ÌïÑÌÑ∞ÎßÅÎêú Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Ï§ÄÏúºÎ°ú AI Î∂ÑÏÑùÏùÑ Ïã§ÌñâÌï©ÎãàÎã§. Î∂ÑÏÑù Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠Ìï¥Ï£ºÏÑ∏Ïöî.
                </span>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <button onclick="runAnalysis()" class="analysis-btn" id="analysisBtn">
                    ü§ñ AI Î∂ÑÏÑù Ïã§Ìñâ
                </button>
            </div>
            <div id="analysisContent" class="analysis-content" style="display: none;">
                <div class="analysis-loading">Î∂ÑÏÑù Ï§ë...</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3>ÌèâÏ†ê Ï∂îÏù¥</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>ÌèâÏ†ê Î∂ÑÌè¨</h3>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Ïä§ÌÜ†Ïñ¥Î≥Ñ ÎπÑÍµê</h3>
                <div class="chart-container">
                    <canvas id="storeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Íµ≠Í∞ÄÎ≥Ñ Î¶¨Î∑∞ Ïàò (iOS)</h3>
                <div class="chart-container">
                    <canvas id="countryChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3>Ïñ∏Ïñ¥Î≥Ñ Î¶¨Î∑∞ Ïàò (Android)</h3>
                <div class="chart-container">
                    <canvas id="languageChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="table-card">
            <h3>ÏµúÍ∑º Î¶¨Î∑∞</h3>
            <table>
                <thead>
                    <tr>
                        <th class="sortable" data-column="date" onclick="sortTable('date')">ÎÇ†Ïßú</th>
                        <th class="sortable" data-column="device" onclick="sortTable('device')">Ïä§ÌÜ†Ïñ¥</th>
                        <th class="sortable" data-column="rating" onclick="sortTable('rating')">ÌèâÏ†ê</th>
                        <th class="sortable" data-column="title" onclick="sortTable('title')">Ï†úÎ™©</th>
                        <th class="sortable" data-column="text" onclick="sortTable('text')">ÎÇ¥Ïö©</th>
                        <th class="sortable" data-column="country" onclick="sortTable('country')">Íµ≠Í∞Ä</th>
                        <th class="sortable" data-column="language" onclick="sortTable('language')">Ïñ∏Ïñ¥</th>
                    </tr>
                </thead>
                <tbody id="reviewsTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SHEET_ID = '1o0d8rSCZD7SbDQmk6NX3Cpg8LYJPNVv3OaW4j51P1tY';
        const SHEET_NAME = 'sheet';
        const ANALYSIS_SHEET_NAME = 'analysis';
        const N8N_WEBHOOK_URL = 'YOUR_N8N_WEBHOOK_URL'; // n8n ÏõπÌõÖ URLÏùÑ Ïó¨Í∏∞Ïóê ÏûÖÎ†•ÌïòÏÑ∏Ïöî
        
        let allData = [];
        let charts = {};
        let tableSortConfig = { column: 'date', direction: 'desc' };
        
        Chart.register(ChartDataLabels);
        
        // ÏöïÏÑ§ ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò
        function filterProfanity(text) {
            if (!text) return text;
            
            // ÌïúÍµ≠Ïñ¥ ÏöïÏÑ§
            const koreanBadWords = [
                'ÏãúÎ∞ú', 'Ïî®Î∞ú', '„ÖÖ„ÖÇ', 'Î≥ëÏã†', '„ÖÇ„ÖÖ', 'Í∞úÏÉà', 'ÏßÄÎûÑ', '„Öà„Ñπ', 
                'ÏóøÎ®π', 'Í∞úÍ∞ô', 'Ï¢Ü', '„ÖàÍ∞ô', 'ÏçÖ', 'Îí§Ïßà', 'ÎØ∏Ïπú', '„ÖÅ„Öä',
                'ÏÉàÎÅº', '„ÖÖ„Ñ≤', 'ÎÖÑ', '„Ñ¥ÏïÑ', 'ÎÜà', 'Ïó†Ï∞Ω', 'ÏóºÎ≥ë', 'Ìò∏Î°ú'
            ];
            
            // ÏòÅÏñ¥ ÏöïÏÑ§
            const englishBadWords = [
                'fuck', 'shit', 'damn', 'bitch', 'bastard', 'asshole', 
                'ass', 'crap', 'piss', 'dick', 'cock', 'pussy', 'whore',
                'slut', 'retard', 'fag', 'nigger', 'cunt'
            ];
            
            // ÏùºÎ≥∏Ïñ¥ ÏöïÏÑ§
            const japaneseBadWords = [
                '„Åè„Åù', '„Éê„Ç´', '„Å∞„Åã', '„Ç¢„Éõ', '„ÅÇ„Åª', '„ÇØ„ÇΩ', '„Éú„Ç±', '„Åº„Åë',
                '„Ç´„Çπ', '„Åã„Åô', 'Ê≠ª„Å≠', '„Åó„Å≠', '„Ç≠„ÉÅ„Ç¨„Ç§', '„Åç„Å°„Åå„ÅÑ', '„Éñ„Çπ'
            ];
            
            let filteredText = text;
            
            // ÌïúÍµ≠Ïñ¥ ÌïÑÌÑ∞ÎßÅ
            koreanBadWords.forEach(word => {
                const regex = new RegExp(word, 'gi');
                filteredText = filteredText.replace(regex, '*'.repeat(word.length));
            });
            
            // ÏòÅÏñ¥ ÌïÑÌÑ∞ÎßÅ (ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ ÏóÜÏù¥)
            englishBadWords.forEach(word => {
                const regex = new RegExp(word, 'gi');
                filteredText = filteredText.replace(regex, '*'.repeat(word.length));
            });
            
            // ÏùºÎ≥∏Ïñ¥ ÌïÑÌÑ∞ÎßÅ
            japaneseBadWords.forEach(word => {
                const regex = new RegExp(word, 'gi');
                filteredText = filteredText.replace(regex, '*'.repeat(word.length));
            });
            
            return filteredText;
        }
        
        // ÎÇ†Ïßú ÌïÑÌÑ∞ Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
        document.getElementById('endDate').valueAsDate = today;
        
        // ÌïÑÌÑ∞ Î≥ÄÍ≤Ω Ïãú ÎåÄÏãúÎ≥¥Îìú ÏóÖÎç∞Ïù¥Ìä∏
        document.getElementById('storeFilter').addEventListener('change', updateDashboard);
        document.getElementById('ratingFilter').addEventListener('change', updateDashboard);
        document.getElementById('startDate').addEventListener('change', updateDashboard);
        document.getElementById('endDate').addEventListener('change', updateDashboard);
        
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
                
                const response = await fetch(url);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allData = results.data.map(row => ({
                            date: row.date,
                            product_name: row.product_name,
                            device: row.device,
                            rating: parseInt(row.rating),
                            title: row.title,
                            text: row.text,
                            version: row.version,
                            country: row.country,
                            language: row.language,
                            review_id: row.review_id
                        })).filter(row => row.date && row.rating);
                        
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        
                        updateDashboard();
                        // loadAnalysis(); // ÏûêÎèô Î°úÎìú Ï†úÍ±∞
                        
                        // Ï¥àÍ∏∞ Ï†ïÎ†¨ ÌëúÏãú (ÎÇ†Ïßú ÎÇ¥Î¶ºÏ∞®Ïàú)
                        const dateTh = document.querySelector('th[data-column="date"]');
                        if (dateTh) {
                            dateTh.classList.add('sorted-desc');
                        }
                    }
                });
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message + '\n\nÍµ¨Í∏Ä ÏãúÌä∏Í∞Ä "ÎßÅÌÅ¨Í∞Ä ÏûàÎäî Î™®Îì† ÏÇ¨Ïö©Ïûê"Î°ú Í≥µÏú† ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
            }
        }
        
        async function loadAnalysis() {
            try {
                const analysisUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${ANALYSIS_SHEET_NAME}`;
                
                const response = await fetch(analysisUrl);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            const latestAnalysis = results.data[results.data.length - 1];
                            displayAnalysis(latestAnalysis);
                        } else {
                            document.getElementById('analysisContent').innerHTML = '<div class="analysis-loading">ÏïÑÏßÅ Î∂ÑÏÑù Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§. n8n ÏõåÌÅ¨ÌîåÎ°úÏö∞Î•º Ïã§ÌñâÌï¥Ï£ºÏÑ∏Ïöî.</div>';
                        }
                    }
                });
            } catch (error) {
                document.getElementById('analysisContent').innerHTML = '<div class="analysis-loading">Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</div>';
            }
        }
        
        function displayAnalysis(analysis) {
            const content = document.getElementById('analysisContent');
            content.innerHTML = `
                <h3>Í∞êÏÑ± Î∂ÑÏÑù</h3>
                <p>${analysis.sentiment_summary || 'Î∂ÑÏÑù Ï§ë...'}</p>
                
                <h3>Ï£ºÏöî Ïù¥Ïäà</h3>
                <ul>
                    ${(analysis.main_issues || '').split('\n').filter(i => i.trim()).map(issue => `<li>${issue}</li>`).join('')}
                </ul>
                
                <h3>Í∞úÏÑ† Ï†úÏïà</h3>
                <ul>
                    ${(analysis.suggestions || '').split('\n').filter(s => s.trim()).map(suggestion => `<li>${suggestion}</li>`).join('')}
                </ul>
                
                <p style="margin-top: 20px; color: #8b949e; font-size: 12px;">
                    Î∂ÑÏÑù ÏùºÏãú: ${analysis.analysis_date || new Date().toLocaleDateString()}
                </p>
            `;
            
            // ÌÇ§ÏõåÎìú ÌëúÏãú
            if (analysis.keywords) {
                displayKeywords(analysis.keywords);
            }
        }
        
        function displayKeywords(keywordsStr) {
            let keywords;
            try {
                keywords = typeof keywordsStr === 'string' ? JSON.parse(keywordsStr) : keywordsStr;
            } catch (e) {
                console.error('ÌÇ§ÏõåÎìú ÌååÏã± Ïò§Î•ò:', e);
                keywords = { positive: [], negative: [], neutral: [] };
            }
            
            // Í∏çÏ†ï ÌÇ§ÏõåÎìú
            const positiveContainer = document.getElementById('positiveKeywords');
            if (keywords.positive && keywords.positive.length > 0) {
                positiveContainer.innerHTML = keywords.positive
                    .map((keyword, index) => {
                        const size = Math.max(12, 20 - index);
                        return `<span class="keyword-tag keyword-positive" style="font-size: ${size}px;">${keyword}</span>`;
                    })
                    .join('');
            } else {
                positiveContainer.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 40px;">ÌÇ§ÏõåÎìú ÏóÜÏùå</div>';
            }
            
            // Î∂ÄÏ†ï ÌÇ§ÏõåÎìú
            const negativeContainer = document.getElementById('negativeKeywords');
            if (keywords.negative && keywords.negative.length > 0) {
                negativeContainer.innerHTML = keywords.negative
                    .map((keyword, index) => {
                        const size = Math.max(12, 20 - index);
                        return `<span class="keyword-tag keyword-negative" style="font-size: ${size}px;">${keyword}</span>`;
                    })
                    .join('');
            } else {
                negativeContainer.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 40px;">ÌÇ§ÏõåÎìú ÏóÜÏùå</div>';
            }
        }
        
        async function runAnalysis() {
            const btn = document.getElementById('analysisBtn');
            const content = document.getElementById('analysisContent');
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            btn.disabled = true;
            btn.textContent = 'Î∂ÑÏÑù Ï§ë...';
            
            // Î∂ÑÏÑù ÏòÅÏó≠ ÌëúÏãú
            content.style.display = 'block';
            content.innerHTML = `
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="text">AIÍ∞Ä Î¶¨Î∑∞Î•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...<br><span style="font-size: 12px; color: #9ca3af;">(20-30Ï¥à ÏÜåÏöî)</span></div>
                </div>
            `;
            
            try {
                // ÌòÑÏû¨ ÌïÑÌÑ∞ÎßÅÎêú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const filteredData = filterData();
                
                // Î∂ÄÏ†ï/Í∏çÏ†ï/Ï§ëÎ¶Ω Î¶¨Î∑∞ Î∂ÑÎ¶¨
                const negativeReviews = filteredData.filter(r => r.rating <= 2);
                const positiveReviews = filteredData.filter(r => r.rating >= 4);
                const neutralReviews = filteredData.filter(r => r.rating === 3);
                
                // ÌîÑÎ°¨ÌîÑÌä∏ Íµ¨ÏÑ±
                const prompt = `Î¶¨Î∑∞ ÌÜµÍ≥Ñ:\n- Ï¥ù Î¶¨Î∑∞ Ïàò: ${filteredData.length}\n- Í∏çÏ†ï Î¶¨Î∑∞ (4-5Ï†ê): ${positiveReviews.length}Í∞ú\n- Ï§ëÎ¶Ω Î¶¨Î∑∞ (3Ï†ê): ${neutralReviews.length}Í∞ú\n- Î∂ÄÏ†ï Î¶¨Î∑∞ (1-2Ï†ê): ${negativeReviews.length}Í∞ú\n\nÎ∂ÄÏ†ï Î¶¨Î∑∞:\n${JSON.stringify(negativeReviews.slice(0, 30).map(r => ({rating: r.rating, title: r.title, text: r.text, date: r.date, device: r.device})), null, 2)}\n\nÍ∏çÏ†ï Î¶¨Î∑∞:\n${JSON.stringify(positiveReviews.slice(0, 10).map(r => ({rating: r.rating, title: r.title, text: r.text, date: r.date, device: r.device})), null, 2)}\n\nÏ§ëÎ¶Ω Î¶¨Î∑∞:\n${JSON.stringify(neutralReviews.slice(0, 10).map(r => ({rating: r.rating, title: r.title, text: r.text, date: r.date, device: r.device})), null, 2)}`;
                
                // n8n ÏõπÌõÖ Ìò∏Ï∂ú
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Î∂ÑÏÑù API Ìò∏Ï∂ú Ïã§Ìå®');
                }
                
                const result = await response.json();
                
                // Í≤∞Í≥º ÌëúÏãú
                displayAnalysisResult(result);
                
                btn.disabled = false;
                btn.textContent = 'ü§ñ AI Î∂ÑÏÑù Ïã§Ìñâ';
                
            } catch (error) {
                console.error('Î∂ÑÏÑù Ïò§Î•ò:', error);
                content.innerHTML = `<div style="color: #f43f5e; text-align: center; padding: 40px;">Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}<br><br>n8n ÏõπÌõÖ URLÏù¥ Ïò¨Î∞îÎ•∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.</div>`;
                btn.disabled = false;
                btn.textContent = 'ü§ñ AI Î∂ÑÏÑù Ïã§Ìñâ';
            }
        }
        
        function displayAnalysisResult(result) {
            const content = document.getElementById('analysisContent');
            content.style.display = 'block';
            
            // ÌÇ§ÏõåÎìú HTML ÏÉùÏÑ±
            let keywordsHtml = '';
            if (result.keywords) {
                let keywords;
                try {
                    keywords = typeof result.keywords === 'string' ? JSON.parse(result.keywords) : result.keywords;
                } catch (e) {
                    keywords = { positive: [], negative: [], neutral: [] };
                }
                
                const positiveKeywordsHtml = keywords.positive && keywords.positive.length > 0
                    ? keywords.positive.map((keyword, index) => {
                        const size = Math.max(12, 18 - index);
                        return `<span class="keyword-tag keyword-positive" style="font-size: ${size}px;">${keyword}</span>`;
                    }).join('')
                    : '<span style="color: #6b7280;">ÏóÜÏùå</span>';
                
                const negativeKeywordsHtml = keywords.negative && keywords.negative.length > 0
                    ? keywords.negative.map((keyword, index) => {
                        const size = Math.max(12, 18 - index);
                        return `<span class="keyword-tag keyword-negative" style="font-size: ${size}px;">${keyword}</span>`;
                    }).join('')
                    : '<span style="color: #6b7280;">ÏóÜÏùå</span>';
                
                keywordsHtml = `
                    <h3>Ï£ºÏöî ÌÇ§ÏõåÎìú</h3>
                    <div style="margin-bottom: 15px;">
                        <div style="color: #14b8a6; font-weight: 600; font-size: 13px; margin-bottom: 8px;">Í∏çÏ†ï ÌÇ§ÏõåÎìú</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                            ${positiveKeywordsHtml}
                        </div>
                    </div>
                    <div>
                        <div style="color: #f43f5e; font-weight: 600; font-size: 13px; margin-bottom: 8px;">Î∂ÄÏ†ï ÌÇ§ÏõåÎìú</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${negativeKeywordsHtml}
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <h3>Í∞êÏÑ± Î∂ÑÏÑù</h3>
                <p>${result.sentiment_summary || 'Î∂ÑÏÑù Í≤∞Í≥º ÏóÜÏùå'}</p>
                
                <h3>Ï£ºÏöî Ïù¥Ïäà</h3>
                <ul>
                    ${(result.main_issues || '').split('\n').filter(i => i.trim()).map(issue => `<li>${issue}</li>`).join('') || '<li>Ïù¥Ïäà ÏóÜÏùå</li>'}
                </ul>
                
                <h3>Í∞úÏÑ† Ï†úÏïà</h3>
                <ul>
                    ${(result.suggestions || '').split('\n').filter(s => s.trim()).map(suggestion => `<li>${suggestion}</li>`).join('') || '<li>Ï†úÏïà ÏóÜÏùå</li>'}
                </ul>
                
                ${keywordsHtml}
            `;
        }
        
        function sortTable(column) {
            // Í∞ôÏùÄ Ïª¨Îüº ÌÅ¥Î¶≠ Ïãú Î∞©Ìñ• ÌÜ†Í∏Ä
            if (tableSortConfig.column === column) {
                tableSortConfig.direction = tableSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                tableSortConfig.column = column;
                tableSortConfig.direction = 'desc';
            }
            
            // Ìó§Îçî Ï†ïÎ†¨ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            const currentTh = document.querySelector(`th[data-column="${column}"]`);
            if (currentTh) {
                currentTh.classList.add(tableSortConfig.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
            
            // ÌÖåÏù¥Î∏î Îã§Ïãú Î†åÎçîÎßÅ
            updateTable(filterData());
        }
        
        function filterData() {
            const storeFilter = document.getElementById('storeFilter').value;
            const ratingFilter = document.getElementById('ratingFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            return allData.filter(row => {
                if (storeFilter !== 'all' && row.device !== storeFilter) return false;
                if (ratingFilter !== 'all' && row.rating !== parseInt(ratingFilter)) return false;
                if (startDate && row.date < startDate) return false;
                if (endDate && row.date > endDate) return false;
                return true;
            });
        }
        
        function updateDashboard() {
            const data = filterData();
            
            // ÏµúÏã† Îç∞Ïù¥ÌÑ∞ ÎÇ†Ïßú Î∞è Î≤îÏúÑ ÌëúÏãú
            if (data.length > 0) {
                const dates = data.map(row => row.date).sort();
                const oldestDate = dates[0];
                const latestDate = dates[dates.length - 1];
                document.getElementById('latestDataDate').textContent = `${oldestDate} ~ ${latestDate}`;
            }
            
            // KPI ÏóÖÎç∞Ïù¥Ìä∏
            updateKPIs(data);
            
            // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateTrendChart(data);
            updateDistributionChart(data);
            updateStoreChart(data);
            updateCountryChart(data);
            updateLanguageChart(data);
            
            // ÌÖåÏù¥Î∏î ÏóÖÎç∞Ïù¥Ìä∏
            updateTable(data);
        }
        
        function updateKPIs(data) {
            const total = data.length;
            const avgRating = (data.reduce((sum, r) => sum + r.rating, 0) / total || 0).toFixed(1);
            const positive = data.filter(r => r.rating >= 4).length;
            const neutral = data.filter(r => r.rating === 3).length;
            const negative = data.filter(r => r.rating <= 2).length;
            const positiveRate = ((positive / total * 100) || 0).toFixed(1);
            const neutralRate = ((neutral / total * 100) || 0).toFixed(1);
            const negativeRate = ((negative / total * 100) || 0).toFixed(1);
            
            document.getElementById('totalReviews').textContent = total.toLocaleString();
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('avgRatingDetails').textContent = `/ 5.0`;
            document.getElementById('positiveRate').textContent = positiveRate + '%';
            document.getElementById('positiveCount').textContent = positive.toLocaleString() + 'Í∞ú';
            document.getElementById('neutralRate').textContent = neutralRate + '%';
            document.getElementById('neutralCount').textContent = neutral.toLocaleString() + 'Í∞ú';
            document.getElementById('negativeRate').textContent = negativeRate + '%';
            document.getElementById('negativeCount').textContent = negative.toLocaleString() + 'Í∞ú';
            
            // iOS vs Android ÎπÑÏú®
            const ios = data.filter(r => r.device === 'ios').length;
            const android = data.filter(r => r.device === 'android').length;
            document.getElementById('reviewsChange').textContent = `iOS: ${ios} | Android: ${android}`;
        }
        
        function updateTrendChart(data) {
            const ctx = document.getElementById('trendChart');
            
            // iOSÏôÄ Android Îç∞Ïù¥ÌÑ∞ Î∂ÑÎ¶¨
            const iosData = data.filter(r => r.device === 'ios');
            const androidData = data.filter(r => r.device === 'android');
            
            // iOS ÎÇ†ÏßúÎ≥Ñ Í∑∏Î£πÌôî
            const iosDateGroups = {};
            iosData.forEach(row => {
                if (!iosDateGroups[row.date]) {
                    iosDateGroups[row.date] = [];
                }
                iosDateGroups[row.date].push(row.rating);
            });
            
            // Android ÎÇ†ÏßúÎ≥Ñ Í∑∏Î£πÌôî
            const androidDateGroups = {};
            androidData.forEach(row => {
                if (!androidDateGroups[row.date]) {
                    androidDateGroups[row.date] = [];
                }
                androidDateGroups[row.date].push(row.rating);
            });
            
            // Î™®Îì† ÎÇ†Ïßú ÏàòÏßë Î∞è Ï†ïÎ†¨
            const allDates = new Set([
                ...Object.keys(iosDateGroups),
                ...Object.keys(androidDateGroups)
            ]);
            const dates = Array.from(allDates).sort();
            
            // iOS ÌèâÍ∑† Í≥ÑÏÇ∞
            const iosAvgRatings = dates.map(date => {
                const ratings = iosDateGroups[date];
                return ratings ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(2) : null;
            });
            
            // Android ÌèâÍ∑† Í≥ÑÏÇ∞
            const androidAvgRatings = dates.map(date => {
                const ratings = androidDateGroups[date];
                return ratings ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(2) : null;
            });
            
            if (charts.trend) charts.trend.destroy();
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'iOS',
                            data: iosAvgRatings,
                            borderColor: '#14b8a6',
                            backgroundColor: 'rgba(20, 184, 166, 0.15)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#14b8a6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Android',
                            data: androidAvgRatings,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.15)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#22d3ee',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: {
                                color: '#6b7280',
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 13 }
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5.5,
                            ticks: { 
                                color: '#6b7280',
                                stepSize: 1,
                                callback: function(value) {
                                    return value <= 5 ? value : '';
                                }
                            },
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            ticks: { color: '#6b7280' },
                            grid: { color: '#e5e7eb' }
                        }
                    }
                }
            });
        }
        
        function updateDistributionChart(data) {
            const ctx = document.getElementById('distributionChart');
            
            // iOSÏôÄ Android Îç∞Ïù¥ÌÑ∞ Î∂ÑÎ¶¨
            const iosData = data.filter(r => r.device === 'ios');
            const androidData = data.filter(r => r.device === 'android');
            
            // iOS ÌèâÏ†ê Î∂ÑÌè¨
            const iosDistribution = [1, 2, 3, 4, 5].map(rating => 
                iosData.filter(r => r.rating === rating).length
            );
            
            // Android ÌèâÏ†ê Î∂ÑÌè¨
            const androidDistribution = [1, 2, 3, 4, 5].map(rating => 
                androidData.filter(r => r.rating === rating).length
            );
            
            if (charts.distribution) charts.distribution.destroy();
            
            charts.distribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['‚≠ê', '‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê'],
                    datasets: [
                        {
                            label: 'iOS',
                            data: iosDistribution,
                            backgroundColor: '#14b8a6',
                            borderRadius: 6,
                            barThickness: 35
                        },
                        {
                            label: 'Android',
                            data: androidDistribution,
                            backgroundColor: '#22d3ee',
                            borderRadius: 6,
                            barThickness: 35
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            labels: {
                                color: '#6b7280',
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 13 }
                            }
                        },
                        datalabels: {
                            color: '#ffffff',
                            font: { 
                                weight: 'bold', 
                                size: 13 
                            },
                            anchor: 'center',
                            align: 'center',
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#6b7280' },
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            ticks: { color: '#6b7280', font: { size: 14 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function updateStoreChart(data) {
            const ctx = document.getElementById('storeChart');
            
            const ios = data.filter(r => r.device === 'ios');
            const android = data.filter(r => r.device === 'android');
            
            const iosAvg = (ios.reduce((sum, r) => sum + r.rating, 0) / ios.length || 0).toFixed(2);
            const androidAvg = (android.reduce((sum, r) => sum + r.rating, 0) / android.length || 0).toFixed(2);
            
            // Î¶¨Î∑∞ ÏàòÏùò ÏµúÎåÄÍ∞í Í≥ÑÏÇ∞
            const maxReviews = Math.max(ios.length, android.length);
            
            if (charts.store) charts.store.destroy();
            
            charts.store = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['iOS', 'Android'],
                    datasets: [
                        {
                            label: 'ÌèâÍ∑† ÌèâÏ†ê',
                            data: [iosAvg, androidAvg],
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: '#f59e0b',
                            yAxisID: 'y1',
                            borderWidth: 4,
                            pointRadius: 8,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 3,
                            pointHoverRadius: 10,
                            order: 1
                        },
                        {
                            label: 'Î¶¨Î∑∞ Ïàò',
                            data: [ios.length, android.length],
                            backgroundColor: ['#14b8a6', '#22d3ee'],
                            yAxisID: 'y',
                            borderRadius: 8,
                            barThickness: 80,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: function(context) {
                                return context.dataset.type === 'line' ? '#f59e0b' : '#ffffff';
                            },
                            font: { 
                                weight: 'bold', 
                                size: function(context) {
                                    return context.dataset.type === 'line' ? 16 : 16;
                                }
                            },
                            formatter: function(value, context) {
                                if (context.dataset.type === 'line') {
                                    return '‚òÖ ' + value;
                                }
                                return value.toLocaleString();
                            },
                            anchor: function(context) {
                                return context.dataset.type === 'line' ? 'end' : 'center';
                            },
                            align: function(context) {
                                return context.dataset.type === 'line' ? 'top' : 'center';
                            },
                            offset: function(context) {
                                return context.dataset.type === 'line' ? 8 : 0;
                            }
                        },
                        legend: {
                            labels: { 
                                color: '#6b7280',
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: { color: '#6b7280' },
                            grid: { color: '#e5e7eb' },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 5,
                            ticks: { 
                                color: '#f59e0b',
                                stepSize: 1
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: { 
                                color: '#6b7280',
                                font: { size: 14 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function updateCountryChart(data) {
            const ctx = document.getElementById('countryChart');
            
            // iOS Îç∞Ïù¥ÌÑ∞Îßå ÌïÑÌÑ∞ÎßÅ
            const iosData = data.filter(r => r.device === 'ios');
            
            const countryGroups = {};
            iosData.forEach(row => {
                const country = row.country || 'Unknown';
                countryGroups[country] = (countryGroups[country] || 0) + 1;
            });
            
            const sortedCountries = Object.entries(countryGroups)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Îã§ÏñëÌïú ÏÉâÏÉÅ ÌåîÎ†àÌä∏ (ÏÑúÎ°ú Íµ¨Î∂ÑÌïòÍ∏∞ Ïâ¨Ïö¥ ÏÉâÏÉÅÎì§)
            const colors = [
                '#14b8a6', // Ìã∏
                '#f59e0b', // Ïò§Î†åÏßÄ
                '#8b5cf6', // Î≥¥Îùº
                '#ec4899', // ÌïëÌÅ¨
                '#3b82f6', // Î∏îÎ£®
                '#10b981', // Í∑∏Î¶∞
                '#f97316', // Îã§ÌÅ¨ Ïò§Î†åÏßÄ
                '#06b6d4', // ÏãúÏïà
                '#a855f7', // ÎùºÏù¥Ìä∏ Î≥¥Îùº
                '#ef4444'  // Î†àÎìú
            ];
            
            if (charts.country) charts.country.destroy();
            
            charts.country = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCountries.map(c => c[0]),
                    datasets: [{
                        data: sortedCountries.map(c => c[1]),
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: '#6b7280',
                                padding: 12,
                                font: { size: 12 }
                            },
                            position: 'right'
                        },
                        datalabels: {
                            color: '#ffffff',
                            font: { 
                                weight: 'bold', 
                                size: 13 
                            },
                            formatter: function(value, context) {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(0);
                                return percentage > 5 ? percentage + '%' : '';
                            }
                        }
                    }
                }
            });
        }
        
        function updateLanguageChart(data) {
            const ctx = document.getElementById('languageChart');
            
            // Android Îç∞Ïù¥ÌÑ∞Îßå ÌïÑÌÑ∞ÎßÅ
            const androidData = data.filter(r => r.device === 'android');
            
            const languageGroups = {};
            androidData.forEach(row => {
                const language = row.language || 'Unknown';
                languageGroups[language] = (languageGroups[language] || 0) + 1;
            });
            
            const sortedLanguages = Object.entries(languageGroups)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Îã§ÏñëÌïú ÏÉâÏÉÅ ÌåîÎ†àÌä∏
            const colors = [
                '#14b8a6', // Ìã∏
                '#f59e0b', // Ïò§Î†åÏßÄ
                '#8b5cf6', // Î≥¥Îùº
                '#ec4899', // ÌïëÌÅ¨
                '#3b82f6', // Î∏îÎ£®
                '#10b981', // Í∑∏Î¶∞
                '#f97316', // Îã§ÌÅ¨ Ïò§Î†åÏßÄ
                '#06b6d4', // ÏãúÏïà
                '#a855f7', // ÎùºÏù¥Ìä∏ Î≥¥Îùº
                '#ef4444'  // Î†àÎìú
            ];
            
            if (charts.language) charts.language.destroy();
            
            charts.language = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedLanguages.map(l => l[0]),
                    datasets: [{
                        data: sortedLanguages.map(l => l[1]),
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { 
                                color: '#6b7280',
                                padding: 12,
                                font: { size: 12 }
                            },
                            position: 'right'
                        },
                        datalabels: {
                            color: '#ffffff',
                            font: { 
                                weight: 'bold', 
                                size: 13 
                            },
                            formatter: function(value, context) {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(0);
                                return percentage > 5 ? percentage + '%' : '';
                            }
                        }
                    }
                }
            });
        }
        
        function updateTable(data) {
            const tbody = document.getElementById('reviewsTable');
            
            // review_id Í∏∞Ï§Ä Ï§ëÎ≥µ Ï†úÍ±∞
            const uniqueData = [];
            const seenIds = new Set();
            
            data.forEach(row => {
                if (row.review_id && !seenIds.has(row.review_id)) {
                    seenIds.add(row.review_id);
                    uniqueData.push(row);
                } else if (!row.review_id) {
                    // review_id ÏóÜÏúºÎ©¥ Í∑∏ÎÉ• Ï∂îÍ∞Ä
                    uniqueData.push(row);
                }
            });
            
            // Ï†ïÎ†¨ Ï†ÅÏö©
            const sortedData = [...uniqueData].sort((a, b) => {
                const column = tableSortConfig.column;
                const direction = tableSortConfig.direction;
                
                let valA = a[column];
                let valB = b[column];
                
                // deviceÎäî ios/androidÎ•º iOS/AndroidÎ°ú Î≥ÄÌôòÌï¥ÏÑú ÎπÑÍµê
                if (column === 'device') {
                    valA = a.device === 'ios' ? 'iOS' : 'Android';
                    valB = b.device === 'ios' ? 'iOS' : 'Android';
                }
                
                // null Ï≤òÎ¶¨
                if (!valA) valA = '';
                if (!valB) valB = '';
                
                // Ïà´Ïûê ÎπÑÍµê (rating)
                if (column === 'rating') {
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
                
                // Î¨∏ÏûêÏó¥ ÎπÑÍµê
                const comparison = String(valA).localeCompare(String(valB));
                return direction === 'asc' ? comparison : -comparison;
            });
            
            const recent = sortedData.slice(0, 20);
            
            tbody.innerHTML = recent.map(row => {
                const filteredTitle = filterProfanity(row.title);
                const filteredText = filterProfanity(row.text);
                const displayText = (filteredText || '').substring(0, 100) + (filteredText && filteredText.length > 100 ? '...' : '');
                
                return `
                <tr>
                    <td>${row.date}</td>
                    <td><span class="device-badge device-${row.device}">${row.device === 'ios' ? 'iOS' : 'Android'}</span></td>
                    <td><span class="rating-badge rating-${row.rating}">${'‚≠ê'.repeat(row.rating)}</span></td>
                    <td>${filteredTitle || '-'}</td>
                    <td>${displayText || '-'}</td>
                    <td>${row.country || '-'}</td>
                    <td>${row.language || '-'}</td>
                </tr>
                `;
            }).join('');
        }
        
        // Ï¥àÍ∏∞ Î°úÎìú
        loadData();
    </script>
    
    <div class="footer">
        Made by JEEYEA CHA
    </div>
</body>
</html>